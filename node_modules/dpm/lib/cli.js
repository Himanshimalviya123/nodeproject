var program = require('commander');
var path = require('path');
var slice = [].slice;
var wrench = require('wrench');
var watch = require('node-watch');

var t = require('./t')();

var isHiddenFile = function(file) {
    return /(?:^|\/)\.\w+/.test(file);
};

program
    .version('0.4.6')
    .usage('<command> <target> [options]')

program
    .command('server <path>')
    .description('在指定路径启动一个静态web服务器 e.g dpm server path')
    .option('-p, --port [int]', '端口号，默认从3000开始找一个可用的端口')
    .action(function(modulePath, cmd) {
        require('./start-server')(modulePath, parseInt(cmd.port) || null);
    });

program
    .command('monitor [path]')
    .description('启动一个websocket服务器 监听目录文件变化，并且告诉到前端')
    .action(function(path, cmd) {
        require('./socket-io-notify')(path || './');
    });    

program
    .command('compile <dir>')
    .description('编译文件')
    .option('-w, --watch', '监听这个目录')
    .action(function(dir, options) {
        var compile = require('./compile-handlers2');
        dir = path.resolve(process.cwd(), dir);

        wrench.readdirRecursive(dir, t(function(files) {
            if (files) {
                files.forEach(function(f) {
                    if (!isHiddenFile(f)) {
                        compile(path.join(dir, f));
                    }
                });
            }
        }));

        if (options.watch) {
            watch(dir, function(f) {
                if (!isHiddenFile(f)) {
                    compile(f);
                }
            })
        }
    });

program
    .command('compress <filePath> <mappingPath>')
    .description('压缩文件')
    .option('-a, --all', '把所有外部模块一起编入')
    .option('-c, --seaconfig <path>', 'seajs-config path')
    // .option('-p, --mappingPath <file>', '这个文件在网站上对应的路径')
    .action(function(filePath, mappingPath, cmd) {        
        if (arguments.length < 3) {
            console.log('参数错误，示例：dpm /path/to/app.js //web-root-path-start-with-double-slash/to/app.js');
        } else {
            //使用两个slash开头，否则系统会把路径直接转换程本机路径，所以这里要去掉一个slash
            if (mappingPath.indexOf('/') === 0) {
                if (mappingPath.indexOf('//') !== 0) {
                    console.log('请输入以//开头的路径，例如：//mod/src/app.js');
                    return;
                }
                mappingPath = mappingPath.substring(1)
            }

            require('./compress')(filePath, mappingPath, cmd);
        }
    });


program
    .command('concat <path>')
    .action(function(dir) { 
        require('./concat')(path.resolve(process.cwd(), dir))
    });

program.parse(process.argv);


